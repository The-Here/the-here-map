<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>The Here â€” Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
    #map { position: absolute; inset: 0; }
    
    #timeline {
      position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
      background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000; min-width: 400px; text-align: center;
    }
    #eras { display: flex; gap: 5px; justify-content: center; margin-bottom: 10px; flex-wrap: wrap; }
    .era-btn {
      padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 4px;
      font-size: 12px; cursor: pointer; transition: all 0.2s;
    }
    .era-btn:hover, .era-btn.active { background: #37879d; color: white; border-color: #37879d; }
    #slider-container { display: flex; align-items: center; gap: 10px; }
    #slider { flex: 1; height: 6px; border-radius: 3px; }
    #year-label { font-weight: 600; min-width: 80px; text-align: right; }
  </style>
</head>
<body>
<div id="map"></div>
<script>
mapboxgl.accessToken = 'pk.eyJ1Ijoibm9ydGhlZGRhIiwiYSI6ImNtYmVjczJ4cTFndnEycW42cnFwbjBjbzcifQ.XYvDSeoj0uD6K8WpK5v0mQ';
const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  projection: 'mercator',
  center: [0, 20],
  zoom: 1,
  minZoom: 1,
  maxZoom: 12
});

const POLYGON_MAX_CLICK_ZOOM = 3;
let allPointLayers = [];

function formatDate(isoDate) {
  if (!isoDate) return '';
  const [year, month, day] = isoDate.split('-');
  const shortMonths = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  const m = shortMonths[parseInt(month) - 1];
  return `${year}, ${m} ${parseInt(day)}`;
}

const MIN_YEAR = -3100;
const MAX_YEAR = 2000;

function applyTimelineFilter(targetYear) {
  const yearFilter = ['<=', ['get', 'start_year'], targetYear];
  
  allPointLayers.forEach(layerId => {
    const sourceId = layerId.split('-')[0];
    ['clusters', 'cluster-count', 'unclustered-point'].forEach(suffix => {
      const fullId = `${sourceId}-${suffix}`;
      if (map.getLayer(fullId)) {
        map.setFilter(fullId, yearFilter);
      }
    });
  });
}

function updateYearLabel(targetYear) {
  document.getElementById('year-label').textContent = 
    targetYear >= 0 ? `${targetYear} CE` : `${Math.abs(targetYear)} BCE`;
}

map.on('load', async () => {
  // Timeline UI
  const timelineHtml = `
    <div id="timeline">
      <div style="font-weight: bold; margin-bottom: 10px;">Timeline</div>
      <div id="eras">
        <button class="era-btn active" data-year="-3100">3100 BCE</button>
        <button class="era-btn" data-year="-500">500 BCE</button>
        <button class="era-btn" data-year="0">0 CE</button>
        <button class="era-btn" data-year="1000">1000 CE</button>
        <button class="era-btn" data-year="1900">1900</button>
        <button class="era-btn" data-year="2000">2000</button>
      </div>
      <div style="display: flex; align-items: center; gap: 10px;">
        <span id="year-label">3100 BCE</span>
        <input id="slider" type="range" min="0" max="1000" value="0" step="1" style="flex: 1; height: 6px;">
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', timelineHtml);

  // Era buttons
  document.querySelectorAll('.era-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.era-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      const year = parseInt(btn.dataset.year);
      const normalized = (year - MIN_YEAR) / (MAX_YEAR - MIN_YEAR);
      document.getElementById('slider').value = Math.round(normalized * 1000);
      applyTimelineFilter(year);
      updateYearLabel(year);
    });
  });

  // Slider
  document.getElementById('slider').add
